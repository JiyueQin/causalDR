---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

options(tibble.print_min = 5, tibble.print_max = 5)
```

# causalDR

<!-- badges: start -->
<!-- badges: end -->

## Overview

`causalDR` is an R package for **doubly robust causal inference with semi-competing risks under covariate-dependent censoring**. Semi-competing risks occur when individuals may experience a non-terminal (e.g., illness) and a terminal event (e.g., death), where the terminal event censors the non-terminal event but not vice versa. The package provides augmented inverse probability weighting (AIPW) estimators that jointly adjust for censoring and treatment assignment. 

The resulting estimators involve two sets of nuisance models: 

- `time_model`: models for the non-terminal event time and the terminal event time, 

- `censor_model` and `PS_model`: models for censoring time and propensity score (PS). 

The estimators are doubly robust (DR) in the following two senses:

- *model DR*: consistency and asymptotic normality (CAN) if either set of the nuisance models is correctly specified and both sets of nuisance estimators are asymptotically linear (e.g., when parametric or semiparametric models are used). 

- *rate DR*: CAN when both sets of the models converge to the truth but at possibly slower than root-$n$ (e.g., when nonparametric machine learning methods are used), as long as their product rate is faster than root-$n$, 

Supported causal estimands include treatment-specific cumulative incidence functions (CIFs) for key event types:

- `CIF1`: risk for the non-terminal event,

- `CIF2`: risk for the terminal event without prior non-terminal event,

- `CIF3`: risk for the terminal event following the non-terminal event 

The package also provides estimates for the treatment effect, which are defined as contrasts of above risk quantities between treatment groups (e.g, risk difference and ratio). Bootstrap is used for standard errors and confidence intervals.  

The package supports flexible estimation of nuisance parameters using **parametric, semi-parametric, and machine learning methods**, including Cox models, random forests, boosting, and spline-based approaches, with optional **cross-fitting** to mitigate overfitting bias. 

The methods implemented in this package correspond to the methodology developed in Qin et al. (2026+).


## Installation

You can install the development version of causalDR from [GitHub](https://github.com/JiyueQin/causalDR) with:

```{r eval=F}
# install.packages("pak")
pak::pak("JiyueQin/causalDR")
```

## Example

This is a basic example with some simulated data.

```{r}
library(causalDR)
# set seed for reproducibility 
set.seed(1)
# simulate a sample of size 200
dat = sim_data(n=200)
head(dat)
```

```{r}
# Estimate all three CIFs at a user-specified grid of times
# without computing SEs
fit1 <- causalAIPCW(data = dat, covars = c("Z1", "Z2"), 
                    time_interest = seq(0.5, 5, by = 0.5),
                    time_model = 'RSF',censor_model = 'Cox', PS_model = 'logit',
                    time1_interest = 1, n_boot = 0)
# point estimates 
knitr::kable(fit1$est, digits = 3)
```

```{r eval=F, echo = F}
fit2 <- causalAIPCW(data = dat, covars = c("Z1", "Z2"), 
                    time_interest = seq(0.5, 5, by = 0.5),
                    time1_interest = 1, n_boot = 200, seed = 1)
saveRDS(fit2, 'doc/fit2.rds')
```

```{r eval=F}
# Estimate all three CIFs and compute SEs by bootstrap
# with default nuisance models
# the command may take a few minutes to execute 
fit2 <- causalAIPCW(data = dat, covars = c("Z1", "Z2"), 
                    time_interest = seq(0.5, 5, by = 0.5),
                    time1_interest = 1, n_boot = 100, seed = 1)
```

```{r echo = F}
fit2 = readRDS('doc/fit2.rds')
```

```{r}
# points estimates and SEs for the last time point(i.e, t = 5)
knitr::kable(tail(fit2$est_se), digits = 3)
# plot the estimated CIFs with 95% CIs
plot_estimates(fit2)
```



## Citation 

To appear. 

## Contact 

Maintained by **Jiyue Qin**,

PhD Candidate in Biostatistics, University of California San Diego,

<j5qin@ucsd.edu>
